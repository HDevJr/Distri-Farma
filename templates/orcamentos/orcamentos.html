{% extends 'core/base.html' %}
{% load l10n %}
{% block title %}Orçamentos - DistriFarma{% endblock %}

{% block content %}
<h2 class="text-ciano fw-bold mb-4 titulo-centralizado">Histórico de Orçamentos</h2>

<div class="d-flex justify-content-between align-items-center mb-3">
  <a href="{% url 'orcamento_add' %}" class="btn btn-success">Novo Orçamento</a>

  <form method="get" action="{% url 'orcamento_list' %}" class="search-fixed-form">
    <input
      type="text"
      name="q"
      placeholder="Buscar por cliente ou ID"
      class="search-fixed-input"
      value="{{ q|default:'' }}"
      autocomplete="off" />
  </form>
</div>

<table class="table table-striped table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>ID</th>
      <th>Cliente</th>
      <th>Data</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody id="tabela-orc">
    {% for o in page_obj %}
    <tr data-row-id="{{ o.id }}">
      <td>
        <a href="{% url 'orcamento_detail' o.pk %}"
           class="js-toggle-orc link-primary text-decoration-none fw-semibold"
           data-url="{% url 'orcamento_detail' o.pk %}"
           title="Ver detalhes">
          {{ o.id }}
        </a>
      </td>
      <td>{{ o.cliente }}</td>
      <td>{{ o.criado_em|date:"d/m/Y" }}</td>
      <td>
        <a class="btn btn-sm action-editar" href="{% url 'orcamento_edit' o.pk %}" title="Editar">
          <i class="fa-solid fa-pen"></i>
        </a>

        {% if not o.convertido_em_venda %}
          <a class="btn btn-sm action-editar" href="{% url 'orcamento_confirmar_conversao' o.pk %}" title="Converter em venda">
            <i class="fa-solid fa-cart-shopping"></i>
          </a>
          <a class="btn btn-sm action-excluir" href="{% url 'orcamento_delete' o.pk %}" title="Excluir">
            <i class="fa-solid fa-xmark"></i>
          </a>
        {% endif %}

        <a type="button" class="btn btn-sm btn-danger" href="{% url 'orcamento_pdf' o.pk %}" title="Baixar PDF">
          <i class="fa-solid fa-file-pdf"></i>
        </a>
      </td>
    </tr>
    {% empty %}
      <tr><td colspan="4" class="text-center text-secondary">Nenhum orçamento encontrado.</td></tr>
    {% endfor %}
  </tbody>
</table>

<div class="d-flex justify-content-center mt-4">
  <nav>
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}">«</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">«</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ q }}">{{ num }}</a></li>
        {% elif forloop.first or forloop.last %}
          <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ q }}">{{ num }}</a></li>
        {% elif forloop.counter == page_obj.number|add:'-3' or forloop.counter == page_obj.number|add:'3' %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}">»</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">»</span></li>
      {% endif %}
    </ul>
  </nav>
</div>
{% endblock %}

{% block content_scripts %}
<script>
document.addEventListener('click', async function (e) {
  const link = e.target.closest('.js-toggle-orc');
  if (!link) return;

  e.preventDefault();

  const tr = link.closest('tr');
  const id = tr.getAttribute('data-row-id');
  const url = link.getAttribute('data-url');

  // se já estiver aberto, fecha
  const next = tr.nextElementSibling;
  if (next && next.classList.contains('orc-details') && next.dataset.forId === id) {
    next.remove();
    return;
  }

  // fecha outros detalhes (opcional)
  document.querySelectorAll('.orc-details').forEach(el => el.remove());

  // cria a linha "carregando"
  const detailsTr = document.createElement('tr');
  detailsTr.className = 'orc-details';
  detailsTr.dataset.forId = id;

  const td = document.createElement('td');
  td.colSpan = 4; // temos 4 colunas
  td.innerHTML = '<div class="text-muted py-3 px-2">Carregando…</div>';

  detailsTr.appendChild(td);
  tr.parentNode.insertBefore(detailsTr, tr.nextElementSibling);

  try {
    const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
    if (!resp.ok) throw new Error('Falha na requisição');
    td.innerHTML = await resp.text();
  } catch (err) {
    td.innerHTML = '<div class="alert alert-danger mb-0">Não foi possível carregar os detalhes.</div>';
  }
});
</script>
<style>
.orc-details > td {
  background: rgba(0,0,0,.03);
  border-top: none !important;
}
</style>
{% endblock %}
